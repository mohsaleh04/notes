ایده‌ی بسیار جذاب و کاربردی‌ای دارید! اتصال مستقیم موبایل و کامپیوتر در بستر شبکه داخلی (LAN) بدون نیاز به اینترنت، هم سرعت بالایی دارد و هم از نظر حریم خصوصی برای کاربران جذاب‌تر است.

اما یک چالش فنی اصلی وجود دارد: **افزونه‌های مرورگر (Browser Extensions) نمی‌توانند به عنوان "سرور" عمل کنند.** یعنی افزونه نمی‌تواند روی لپ‌تاپ منتظر بماند تا موبایل به آن درخواست بفرستد (چون مرورگر اجازه‌ی باز کردن پورت را به افزونه نمی‌دهد).

بنابراین، معماری باید برعکس باشد: **موبایل (اندروید) باید سرور شود و افزونه (لپ‌تاپ) باید به آن وصل شود.**

در اینجا نقشه راه (Roadmap) فنی برای پیاده‌سازی این قابلیت را برای شما توضیح می‌دهم:

### معماری کلی سیستم (LAN Architecture)

1.  **سمت اندروید (Server):** برنامه شما یک "وب‌سوکت سرور" (WebSocket Server) سبک راه می‌اندازد.
2.  **سمت افزونه (Client):** افزونه مرورگر به IP گوشی شما در شبکه وای‌فای متصل می‌شود.
3.  **انتقال داده:** به محض دریافت پیامک، اندروید پیام را از طریق کانال باز شده‌ی وب‌سوکت به افزونه می‌فرستد (Push می‌کند).

---

### گام ۱: سمت اندروید (ساخت وب‌سوکت سرور)

شما نیاز دارید که یک سرور سبک داخل اپلیکیشن خود اجرا کنید. برای این کار کتابخانه‌هایی وجود دارند که نیاز به دانش پیچیده شبکه ندارند.

**کتابخانه پیشنهادی:** `AndroidAsync` یا `NanoHTTPD` (نسخه WebSocket).
*پیشنهاد من `AndroidAsync` یا `Ktor` است چون مدیریت وب‌سوکت در آن‌ها راحت‌تر است.*

**کاری که باید در اندروید انجام دهید:**
1.  یک سرویس (Foreground Service) بسازید که وقتی کاربر دکمه "اتصال به کامپیوتر" را زد، اجرا شود (تا با بسته شدن برنامه، سرور قطع نشود).
2.  داخل سرویس، یک WebSocket Server روی یک پورت خاص (مثلاً `8080`) استارت کنید.
3.  IP لوکال گوشی (مثلاً `192.168.1.5`) را پیدا کنید و روی صفحه نمایش دهید تا کاربر آن را ببیند.
4.  وقتی `BroadcastReceiver` پیامک شما (که الان هم دارید) فعال شد و کد را تشخیص داد، چک کنید آیا کلاینتی (افزونه) به سوکت وصل است؟ اگر بله، کد را به صورت JSON بفرستید.

**نمونه کد کاتلین (با استفاده از Ktor یا منطق کلی):**
```kotlin
// شبه کد برای درک منطق
val server = embeddedServer(Netty, port = 8080) {
    routing {
        webSocket("/otp") {
            // وقتی افزونه وصل شد، این سشن را در یک لیست ذخیره کن
            clients.add(this) 
            try {
                for (frame in incoming) {
                    // دریافت پیام از افزونه (مثلا پینگ)
                }
            } finally {
                clients.remove(this)
            }
        }
    }
}
server.start(wait = false)

// وقتی پیامک آمد:
fun onOtpDetected(otp: String, amount: String?) {
    val json = """{"otp": "$otp", "amount": "$amount"}"""
    clients.forEach { it.send(Frame.Text(json)) }
}
```

---

### گام ۲: سمت افزونه (ساخت افزونه کروم/فایرفاکس)

افزونه شما نقش کلاینت را بازی می‌کند.

**ساختار افزونه:**
1.  **manifest.json:**
    نیاز به دسترسی به شبکه دارد (معمولاً دسترسی خاصی برای لوکال نیاز نیست اما باید `permissions` درست تنظیم شود).
2.  **Popup.html:**
    یک ورودی متنی که کاربر IP گوشی (که در اپ اندروید می‌بیند) را وارد کند (مثلاً `192.168.1.5`).
3.  **Background Script (Service Worker):** 
   کد اصلی که اتصال را زنده نگه می‌دارد.

**کاری که باید در جاوااسکریپت افزونه انجام دهید:**

```javascript
// background.js یا داخل اسکریپت popup
let socket;

function connectToMobile(ipAddress) {
    // اتصال به وب‌سوکت سرور روی موبایل
    socket = new WebSocket(`ws://${ipAddress}:8080/otp`);

    socket.onopen = function(e) {
        console.log("اتصال برقرار شد");
        // می‌توانید آیکون افزونه را سبز کنید
    };

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log("OTP Received:", data.otp);
        
        // نمایش نوتیفیکیشن یا کپی در کلیپ‌بورد
        copyToClipboard(data.otp);
        showNotification(data.otp, data.amount);
    };

    socket.onclose = function(event) {
        console.log("اتصال قطع شد");
        // تلاش برای اتصال مجدد (Reconnection logic)
    };
}
```

---

### چالش‌ها و نکات مهم UX (تجربه کاربری)

از آنجایی که می‌خواهید روی شبکه داخلی (LAN) کار کنید، با چند چالش روبرو می‌شوید که باید در برنامه هندل کنید:

1.  **تغییر IP موبایل:**
    هر بار که کاربر وای‌فای را قطع و وصل کند، ممکن است مودم IP جدیدی به گوشی بدهد (DHCP).
    *   *راه حل:* در اپلیکیشن اندروید، همیشه IP فعلی را بزرگ نمایش دهید. در افزونه هم قابلیت ذخیره آخرین IP را بگذارید اما اجازه ویرایش سریع بدهید.

2.  **فایروال ویندوز/لپ‌تاپ:**
    معمولاً وب‌سوکت مشکلی ندارد، اما گاهی اوقات اگر شبکه به عنوان Public Network تنظیم شده باشد، ممکن است در ارتباط اختلال ایجاد شود. (البته چون گوشی سرور است، فایروال ویندوز کمتر دخالت می‌کند، این نکته مثبت ماجراست).

3.  **مصرف باتری:**
    اجرای وب‌سوکت سرور روی اندروید باتری مصرف می‌کند.
    *   *راه حل:* یک دکمه (Toggle) بگذارید که کاربر وقتی پشت سیستم است آن را روشن کند و وقتی کارش تمام شد خاموش کند. یا اینکه تایمر بگذارید که اگر ۱۰ دقیقه کلاینتی وصل نبود، سرور خاموش شود.

4.  **امنیت (HTTP vs HTTPS):**
    در شبکه داخلی شما نمی‌توانید به راحتی HTTPS داشته باشید (چون گواهی SSL برای IP لوکال صادر نمی‌شود). مرورگرهای مدرن ممکن است به اتصال `ws://` (غیر امن) از داخل صفحه‌ای که `https://` است ایراد بگیرند (Mixed Content).
    *   *نکته:* چون این یک افزونه (Extension) است، معمولاً محدودیت‌های کمتری نسبت به یک وب‌سایت معمولی دارد، اما باید تست کنید.

### پیشنهاد جایگزین (اگر LAN اذیت کرد)

اگر دیدید کاربران با وارد کردن IP مشکل دارند یا شبکه داخلی‌شان محدودیت دارد، راه حل جایگزین استفاده از **Firebase Cloud Messaging (FCM)** یا یک سرور واسط (Relay Server) ساده است:
1.  اندروید پیام را به سرور اینترنتی می‌فرستد.
2.  افزونه به سرور اینترنتی وصل است و پیام را می‌گیرد.
*مزیت:* نیاز به وارد کردن IP نیست و همیشه کار می‌کند.
*عیب:* نیاز به اینترنت دارد (که شاید خلاف هدف شما باشد).

### خلاصه کاری که باید بکنید:

1.  در **اندروید**، کتابخانه `NanoHTTPD` یا `Ktor` را اضافه کنید و یک WebSocket Server روی پورت 8080 بسازید.
2.  در **اندروید**، کدی بنویسید که وقتی OTP کشف شد، آن را به تمام کلاینت‌های متصل به سوکت `send` کند.
3.  در **افزونه**، یک UI ساده بسازید که کاربر IP گوشی را وارد کند و دکمه Connect را بزند.
4.  در **افزونه**، با استفاده از `new WebSocket()` به گوشی وصل شوید و به رویداد `onmessage` گوش دهید تا OTP را بگیرید و نمایش دهید.

موفق باشید! اگر در کدنویسی هر بخش مشکلی داشتید، بپرسید تا نمونه کد دقیق‌تر بدهم.